---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import Navigation from "../components/Navigation.astro";
import Footer from "../components/Footer.astro";
---

<script>
  import { userStore, csrfTokenStore } from "../utils/store";

  const user = userStore.get();
  const csrfToken = csrfTokenStore.get();
  if (!user || !csrfToken) {
    window.location.href = "/login";
  }
</script>

<Layout
  title="Settings ‚Äî Vulnera"
  description="Manage your API keys and account settings."
>
  <Navigation />
  <section
    id="main"
    class="relative min-h-screen flex items-center justify-center overflow-hidden bg-black py-8 sm:py-12 md:py-20"
    aria-labelledby="settings-title"
  >
    <div class="absolute inset-0 z-0">
      <div class="absolute inset-0 matrix-rain opacity-20"></div>
      <div
        class="absolute inset-0 bg-gradient-to-r from-black via-black/80 to-black/60"
      >
      </div>
      <div
        class="absolute inset-0 bg-gradient-to-b from-transparent via-matrix-900/20 to-black/80"
      >
      </div>
    </div>

    <div class="relative z-10 w-full max-w-6xl px-3 sm:px-4 md:px-6">
      <div class="mb-6 mt-6 sm:mt-8 md:mt-8 text-center">
        <h1
          id="settings-title"
          class="text-2xl sm:text-3xl md:text-4xl font-bold text-white font-mono tracking-wider"
        >
          <span class="text-cyber-400">&gt;</span> SETTINGS
        </h1>
        <p class="text-matrix-300 mt-2">
          Manage your API keys and account settings
        </p>
      </div>

      <div
        class="terminal-border bg-black/80 rounded-xl shadow-xl overflow-hidden"
      >
        <div class="flex items-center space-x-2 px-4 sm:px-6 pt-4 pb-2">
          <span class="w-3 h-3 rounded-full bg-red-500"></span>
          <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
          <span class="w-3 h-3 rounded-full bg-green-500"></span>
          <span class="ml-3 text-xs text-gray-400">vulnera@settings:~</span>
        </div>

        <div class="flex flex-col md:flex-row">
          <!-- Sidebar Navigation -->
          <nav
            class="md:w-56 lg:w-64 border-r border-matrix-500/30 bg-black/40"
          >
            <ul id="nav-list" class="py-4">
              <li>
                <button
                  class="settings-tab w-full text-left px-6 py-3 font-mono text-sm transition-all duration-200 hover:bg-cyber-400/10 hover:border-l-4 hover:border-cyber-400"
                  data-tab="api-keys"
                >
                  <span class="flex items-center gap-2">
                    <span>üîë</span>
                    <span>API Keys</span>
                  </span>
                </button>
              </li>
              <li>
                <button
                  class="settings-tab w-full text-left px-6 py-3 font-mono text-sm transition-all duration-200 hover:bg-cyber-400/10 hover:border-l-4 hover:border-cyber-400"
                  data-tab="create-org"
                >
                  <span class="flex items-center gap-2">
                    <span>üè¢</span>
                    <span>Create Organization</span>
                  </span>
                </button>
              </li>
            </ul>
          </nav>

          <!-- Content Area -->
          <div class="flex-1 p-6 md:p-8">
            <!-- API Keys Tab -->
            <div id="api-keys-tab" class="tab-content hidden">
              <h2 class="text-2xl font-bold text-cyber-400 mb-6 font-mono">
                API Keys
              </h2>
              <div>
                <!-- API Keys Section -->
                <div>
                  <h3
                    class="text-base sm:text-lg font-bold text-cyber-400 font-mono mb-4"
                  >
                    Vulnera API Keys
                  </h3>

                  <!-- Info Notice -->
                  <div
                    class="mb-4 bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-3"
                  >
                    <div class="flex items-start gap-2">
                      <span class="text-yellow-400 text-lg">‚ÑπÔ∏è</span>
                      <div class="flex-1 text-xs text-gray-300">
                        <p class="font-bold text-yellow-400 mb-1">
                          Note: Limited Features
                        </p>
                        <p>
                          Currently you can create and delete API keys.
                          Enable/Disable functionality will be available when
                          backend implements it.
                        </p>
                      </div>
                    </div>
                  </div>

                  <div class="mb-4">
                    <button
                      id="create-api-key-btn"
                      class="bg-cyber-400 hover:bg-cyber-500 text-black font-bold py-2 px-6 rounded transition-all duration-300 font-mono cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <span id="create-api-key-text">üîë Create New API Key</span
                      >
                      <span id="create-api-key-loading" class="hidden"
                        >‚è≥ Creating...</span
                      >
                    </button>
                  </div>

                  <div id="api-keys-container" class="space-y-3">
                    <div class="text-center py-8 text-matrix-300">
                      <p>Loading API keys...</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Create Organization Tab -->
              <div id="create-org-tab" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-cyber-400 mb-6 font-mono">
                  Create Organization
                </h2>
                <div class="space-y-6">
                  <div
                    class="bg-cyber-900/10 border border-cyber-500/30 rounded-lg p-4"
                  >
                    <h3 class="text-lg font-bold text-cyber-300 mb-4 font-mono">
                      Organization Setup
                    </h3>
                    <p class="text-sm text-gray-400 mb-4">
                      Create an organization to manage multiple users and
                      projects.
                    </p>
                    <button
                      id="create-organization"
                      class="w-full bg-cyber-500/20 hover:bg-cyber-500/30 text-cyber-400 font-bold py-2 px-4 rounded transition-all duration-300 font-mono text-sm"
                    >
                      üè¢ Create Organization
                    </button>
                  </div>
                </div>
              </div>

              <!-- Organization Settings Tab -->
              <div id="org-settings">
                <div id="org-settings-tab" class="tab-content hidden">
                  <h2 class="text-2xl font-bold text-orange-400 mb-6 font-mono">
                    Organization Settings
                  </h2>
                  <div class="space-y-6">
                    <div
                      class="bg-orange-900/10 border border-orange-500/30 rounded-lg p-4"
                    >
                      <h3
                        class="text-lg font-bold text-orange-500 mb-1 font-mono"
                      >
                        Organization Data
                      </h3>
                      <p class="text-sm text-orange-300 mb-4">
                        Manage your organization's settings and preferences.
                      </p>
                      <p>
                        <strong class="text-orange-500 mb-1"
                          >Organization Name:</strong
                        >
                        <input
                          type="text"
                          class="w-full mb-1 px-4 py-3 rounded-lg bg-black/60 border border-orange-400/30 focus:border-orange-400 focus:ring-2 focus:ring-orange-400 text-white placeholder-gray-500"
                          id="org-name-display"
                          value="Loading..."
                        />
                      </p>
                      <button
                        id="change-name"
                        class="w-full bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 font-bold py-2 px-4 rounded transition-all duration-300 font-mono text-sm"
                      >
                        üè¢ Change Organization Name
                      </button>
                    </div>
                    <!-- Divider -->
                    <div class="border-t border-matrix-500/30 my-6"></div>
                    <p class="text-lg text-cyber-400 mb-4">Invite Member</p>
                    <input
                      type="text"
                      class="w-full px-4 py-3 rounded-lg bg-black/60 border border-cyber-400/30 focus:border-cyber-400 focus:ring-2 focus:ring-cyber-400 text-white placeholder-gray-500"
                      id="invite-member-input"
                      placeholder="Enter Member Email"
                    />
                    <button
                      id="invite-member"
                      class="w-full bg-cyber-500/20 hover:bg-cyber-500/30 text-cyber-400 font-bold py-2 px-4 rounded transition-all duration-300 font-mono text-sm"
                    >
                      üìß Invite Member
                    </button>
                    <p class="text-lg text-cyber-400 mb-4">
                      Transfer Organization Ownership
                    </p>
                    <input
                      type="text"
                      class="w-full px-4 py-3 rounded-lg bg-black/60 border border-cyber-400/30 focus:border-cyber-400 focus:ring-2 focus:ring-cyber-400 text-white placeholder-gray-500"
                      id="transfer-ownership-input"
                      placeholder="Enter New Owner ID"
                    />

                    <button
                      id="transfer-ownership"
                      class="w-full bg-cyber-500/20 hover:bg-cyber-500/30 text-cyber-400 font-bold py-2 px-4 rounded transition-all duration-300 font-mono text-sm"
                    >
                      üîÑ Transfer Ownership
                    </button>
                    <!-- Divider -->
                    <div class="border-t border-matrix-500/30 my-6"></div>
                    <p class="text-lg text-red-400 mb-4">Remove Member</p>
                    <input
                      type="text"
                      class="w-full px-4 py-3 rounded-lg bg-black/60 border border-red-400/30 focus:border-red-400 focus:ring-2 focus:ring-red-400 text-white placeholder-gray-500"
                      id="remove-member-input"
                      placeholder="Enter Member ID"
                    />
                    <button
                      id="remove-member"
                      class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 font-bold py-2 px-4 rounded transition-all duration-300 font-mono text-sm"
                    >
                      ‚ùå Remove Member
                    </button>
                    <p class="text-lg text-red-400 mb-1">Leave Organization</p>
                    <p class="text-sm text-red-200 mb-4">
                      if you are the owner of the organization the organization
                      will be permanently deleted after your exit. To prevent
                      that transfer ownership before leaving
                    </p>
                    <button
                      id="leave-organization"
                      class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 font-bold py-2 px-4 rounded transition-all duration-300 font-mono text-sm"
                    >
                      üö™ Leave Organization
                    </button>
                    <p class="text-lg text-red-400 mb-4">Delete Organization</p>
                    <button
                      id="delete-organization"
                      class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 font-bold py-2 px-4 rounded transition-all duration-300 font-mono text-sm"
                    >
                      üóëÔ∏è Delete Organization
                    </button>
                  </div>
                </div>
              </div>
          </div>
        </div>
      </div>

      <Footer />

      <div
        id="create-key-modal"
        class="hidden fixed inset-0 bg-black/80 z-50 p-4"
      >
        <div class="terminal-border bg-black/95 rounded-xl p-6 max-w-md w-full">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-cyber-400 font-mono">
              Generate API Key
            </h3>
            <button
              id="close-modal-btn"
              class="text-gray-400 hover:text-white text-2xl">&times;</button
            >
          </div>

          <form id="create-key-form" class="space-y-4">
            <div>
              <label
                for="key-name"
                class="block text-sm text-matrix-300 mb-2 font-mono"
                >Key Name</label
              >
              <input
                type="text"
                id="key-name"
                placeholder="e.g., Production API Key"
                class="w-full bg-black/50 border border-matrix-500/30 rounded px-4 py-2 text-white focus:outline-none focus:border-cyber-400 font-mono"
                required
              />
            </div>

            <div>
              <label
                for="key-description"
                class="block text-sm text-matrix-300 mb-2 font-mono"
                >Description (Optional)</label
              >
              <textarea
                id="key-description"
                placeholder="What will this key be used for?"
                rows="3"
                class="w-full bg-black/50 border border-matrix-500/30 rounded px-4 py-2 text-white focus:outline-none focus:border-cyber-400 font-mono"
              ></textarea>
            </div>

            <div class="flex gap-3">
              <button
                type="submit"
                class="flex-1 bg-cyber-400 hover:bg-cyber-500 text-black font-bold py-2 px-4 rounded transition-all duration-300 font-mono"
              >
                Generate
              </button>
              <button
                type="button"
                id="cancel-modal-btn"
                class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition-all duration-300 font-mono"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>

      <div
        id="key-display-modal"
        class="hidden fixed inset-0 bg-black/80 z-50 p-4"
      >
        <div class="terminal-border bg-black/95 rounded-xl p-6 max-w-md w-full">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-cyber-400 font-mono">
              API Key Generated
            </h3>
          </div>

          <div class="space-y-4">
            <div class="bg-red-900/20 border border-red-500/50 rounded p-4">
              <p class="text-red-400 text-sm font-mono">
                ‚ö†Ô∏è Make sure to copy your API key now. You won't be able to see
                it again!
              </p>
            </div>

            <div>
              <label class="block text-sm text-matrix-300 mb-2 font-mono"
                >Your API Key</label
              >
              <div class="flex gap-2">
                <input
                  type="text"
                  id="generated-key"
                  readonly
                  class="flex-1 bg-black/50 border border-matrix-500/30 rounded px-4 py-2 text-cyber-400 font-mono text-sm"
                />
                <button
                  id="copy-key-btn"
                  class="bg-cyber-400 hover:bg-cyber-500 text-black font-bold px-4 py-2 rounded transition-all duration-300 font-mono"
                >
                  Copy
                </button>
              </div>
            </div>

            <button
              id="close-key-display-btn"
              class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition-all duration-300 font-mono"
            >
              Close
            </button>
          </div>
        </div>
      </div>

      <script>
import { isOrgStore, organizationStore } from "../utils/store";

        function updateOrgTab() {
          let organization = organizationStore.get();
          let isOrg = isOrgStore.get();
          if (isOrg && organization && organization.id) {
            const navList = document.getElementById("nav-list");
            console.log("Organization detected, adding Org Settings tab.");
            if (navList && navList.children.length > 1) {
              const orgSettingTab = document.createElement("li");
              orgSettingTab.innerHTML = `
                  <button
                    class="settings-tab w-full text-left px-6 py-3 font-mono text-sm transition-all duration-200 hover:bg-cyber-400/10 hover:border-l-4 hover:border-cyber-400"
                    data-tab="org-settings"
                  >
                    <span class="flex items-center gap-2">
                      <span>‚öôÔ∏è</span>
                      <span>Organization Settings</span>
                    </span>
                  </button>
                `;
              navList.replaceChild(orgSettingTab, navList.children[1]);
            }
          }
        }

        function switchTab(tabName: string) {
          const tabButtons = document.querySelectorAll(".settings-tab");
          const tabContents = document.querySelectorAll(".tab-content");

          // Hide all tabs
          tabContents.forEach((content) => {
            content.classList.add("hidden");
          });

          // Remove active state from all buttons
          tabButtons.forEach((btn) => {
            btn.classList.remove(
              "active",
              "bg-cyber-400/10",
              "border-l-4",
              "border-cyber-400",
              "text-cyber-400",
            );
            btn.classList.add("text-matrix-300");
          });          

          // Show selected tab
          const selectedTab = document.getElementById(`${tabName}-tab`);
          if (selectedTab) {
            selectedTab.classList.remove("hidden");
          }

          // Highlight active button
          const activeButton = document.querySelector(
            `[data-tab="${tabName}"]`,
          );
          if (activeButton) {
            activeButton.classList.add(
              "active",
              "bg-cyber-400/10",
              "border-l-4",
              "border-cyber-400",
              "text-cyber-400",
            );
            activeButton.classList.remove("text-matrix-300");
          }
        }

        //listen for organization store changes
        const subscribeOrgStore = organizationStore.subscribe((org) => {
          updateOrgTab();
          //listen for name changes
          if (org && org.id) {
            const orgNameInput = document.getElementById("org-name-display") as HTMLInputElement;
            if (orgNameInput) {
              orgNameInput.value = org.name || "";
            }
          }

          const tabButtons = document.querySelectorAll(".settings-tab");
           // Add click event listeners to tab buttons
          tabButtons.forEach((button) => {
            button.addEventListener("click", () => {
              const tabName = button.getAttribute("data-tab");
              if (tabName) {
                switchTab(tabName);
              }
            });
          });
        });

        const subscribeIsOrg = isOrgStore.subscribe((isOrg) => {
          console.debug("isOrgStore changed:", isOrg);
          updateOrgTab();
        });

        updateOrgTab();

        document.addEventListener("DOMContentLoaded", async () => {
          const { Settings } = await import("../modules/settings");

          // Organization tab setup - after imports are complete

          const settingsHandler = new Settings();

          const createOrgBtn = document.getElementById(
            "create-organization",
          ) as HTMLAnchorElement;
          const changeName = document.getElementById(
            "change-name",
          ) as HTMLAnchorElement;
          const changeNameValue = document.getElementById(
            "org-name-display",
          ) as HTMLInputElement;
          const inviteMember = document.getElementById(
            "invite-member",
          ) as HTMLAnchorElement;
          const inviteMemberInput = document.getElementById(
            "invite-member-input",
          ) as HTMLInputElement;
          const transferOwnership = document.getElementById(
            "transfer-ownership",
          ) as HTMLAnchorElement;
          const transferOwnershipInput = document.getElementById(
            "transfer-ownership-input",
          ) as HTMLInputElement;
          const removeMember = document.getElementById(
            "remove-member",
          ) as HTMLAnchorElement;
          const removeMemberInput = document.getElementById(
            "remove-member-input",
          ) as HTMLInputElement;
          const leaveOrganization = document.getElementById(
            "leave-organization",
          ) as HTMLAnchorElement;
          const deleteOrganization = document.getElementById(
            "delete-organization",
          ) as HTMLAnchorElement;

          changeNameValue.value = organizationStore.get()?.name || "";

          createOrgBtn.addEventListener("click", () => {
            window.location.href = "/orgsignup";
          });

          changeName.addEventListener("click", async () => {
            await settingsHandler.changeOrgName(changeNameValue.value);
          });

          inviteMember.addEventListener("click", async () => {
            await settingsHandler.inviteMember(inviteMemberInput.value);
          });

          transferOwnership.addEventListener("click", async () => {
            await settingsHandler.transferOwnership(transferOwnershipInput.value);
          });

          removeMember.addEventListener("click", async () => {
            await settingsHandler.removeMember(removeMemberInput.value);
          });

          leaveOrganization.addEventListener("click", async () => {
            await settingsHandler.leaveOrganization();
          });

          deleteOrganization.addEventListener("click", async () => {
            await settingsHandler.deleteOrganization();
          });


          // Check for hash navigation on page load
          const hash = window.location.hash.replace("#", "");
          if (
            hash &&
            ["api-keys", "create-org", "org-settings"].includes(hash)
          ) {
            switchTab(hash);
          } else {
            // Initialize first tab
            switchTab("api-keys");
          }

          // Close the DOMContentLoaded event listener
          });

          window.addEventListener("beforeunload", () => {
            subscribeOrgStore();
            subscribeIsOrg();
          });

          // async function loadApiKeys(forceRefresh = false) {
          //   try {
          //     console.debug("loadApiKeys called", { forceRefresh });
          //     const response = await authService.listApiKeys(forceRefresh);
          //     console.debug("listApiKeys response received", {
          //       success: response.success,
          //       status: response.status,
          //       hasData: !!response.data,
          //     });

          //     if (!response.success) {
          //       let errorMsg = response.error || "Failed to load API keys";

          //       if (response.status === 404) {
          //         // 404 means endpoint not implemented - show empty state
          //         const container =
          //           document.getElementById("api-keys-container");
          //         if (container) {
          //           container.innerHTML = `
          //         <div class="text-center py-8">
          //           <div class="text-yellow-400 mb-2">‚ö†Ô∏è API Keys Feature Not Available</div>
          //           <p class="text-matrix-300 text-sm">
          //             The backend API does not support API keys yet.<br/>
          //             Please use JWT authentication or contact your administrator.
          //           </p>
          //         </div>
          //       `;
          //         }
          //         return; // Don't throw error, just show message
          //       }

          //       // Handle rate limiting
          //       if (response.status === 429) {
          //         const container =
          //           document.getElementById("api-keys-container");
          //         if (container) {
          //           container.innerHTML = `
          //         <div class="text-center py-8">
          //           <div class="text-orange-400 mb-2">‚è±Ô∏è Rate Limited</div>
          //           <p class="text-matrix-300 text-sm">
          //             ${errorMsg}<br/>
          //             Try loading API keys again after the wait period.
          //           </p>
          //         </div>
          //       `;
          //         }
          //         return; // Don't throw error, just show retry message
          //       }

          //       throw new Error(errorMsg + ` (HTTP ${response.status || 500})`);
          //     }

          //     const data = response.data as any;
          //     const container = document.getElementById("api-keys-container");

          //     if (!container) return;

          //     // Debug: Log the response structure
          //     console.debug("API Keys Response", {
          //       data,
          //       type: typeof data,
          //       isArray: Array.isArray(data),
          //     });

          //     // Ensure data is an array - handle multiple response formats
          //     let keys: any[] = [];
          //     if (Array.isArray(data)) {
          //       keys = data;
          //     } else if (data?.data && Array.isArray(data.data)) {
          //       keys = data.data;
          //     } else if (data?.keys && Array.isArray(data.keys)) {
          //       keys = data.keys;
          //     } else if (data?.api_keys && Array.isArray(data.api_keys)) {
          //       keys = data.api_keys;
          //     } else if (data?.items && Array.isArray(data.items)) {
          //       keys = data.items;
          //     } else {
          //       console.warn("Unknown API keys response format", data);
          //     }

          //     console.debug("Extracted keys", {
          //       keys,
          //       count: keys.length,
          //       keyIds: keys.map((k: any) => k.id || k.key_id),
          //     });

          //     if (!keys || keys.length === 0) {
          //       console.debug("No keys found, clearing container");
          //       container.innerHTML = `
          //     <div class="text-center py-8 text-matrix-300">
          //       <p>No API keys yet. Generate one to get started.</p>
          //     </div>
          //   `;
          //       return;
          //     }

          //     console.debug("Rendering keys to container", {
          //       count: keys.length,
          //     });
          //     container.innerHTML = keys
          //       .map((key: any) => {
          //         // Extract key ID with multiple fallbacks to handle different response formats
          //         const keyId =
          //           key.key_id || key.id || key.uuid || key.api_key_id;

          //         // Validate that we have a key ID before rendering
          //         if (!keyId) {
          //           console.warn("API key missing ID field", { key });
          //           return "";
          //         }

          //         // Check if API supports is_active field (for toggling)
          //         const hasActiveField = key.hasOwnProperty("is_active");
          //         const isActive = key.is_active !== false; // Default to true if field doesn't exist

          //         // Calculate expiry status
          //         const expiresAt = key.expires_at
          //           ? new Date(key.expires_at)
          //           : null;
          //         const isExpired = expiresAt && expiresAt < new Date();

          //         return `
          //   <div class="terminal-border bg-black/50 rounded-lg p-4 flex items-center justify-between">
          //     <div class="flex-1">
          //       <div class="flex items-center gap-3 mb-2">
          //         <h3 class="text-white font-mono font-bold">${key.name || "Unnamed Key"}</h3>
          //         <span class="key-status-badge px-2 py-1 rounded text-xs font-mono ${
          //           isExpired
          //             ? "bg-red-500/20 text-red-400"
          //             : isActive
          //               ? "bg-green-500/20 text-green-400"
          //               : "bg-orange-500/20 text-orange-400"
          //         }" data-key-id="${keyId}">
          //           ${isExpired ? "‚è∞ EXPIRED" : isActive ? "üîí ACTIVE" : "üîì INACTIVE"}
          //         </span>
          //       </div>
          //       <p class="text-sm text-matrix-300 font-mono">Key: ${key.masked_key || key.key_preview || "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"}</p>
          //       ${key.description ? `<p class="text-sm text-gray-500 mt-1">${key.description}</p>` : ""}
          //       <div class="flex items-center gap-4 mt-2 text-xs text-gray-600">
          //         <span>Created: ${new Date(key.created_at).toLocaleDateString()}</span>
          //         ${key.expires_at ? `<span>Expires: ${new Date(key.expires_at).toLocaleDateString()}</span>` : ""}
          //         ${key.last_used_at ? `<span>Last used: ${new Date(key.last_used_at).toLocaleDateString()}</span>` : "<span>Never used</span>"}
          //       </div>
          //     </div>
          //     <div class="flex gap-2">
          //       ${
          //         hasActiveField
          //           ? `
          //       <button
          //         class="toggle-key-btn ${isActive ? "bg-orange-500/20 text-orange-400 hover:bg-orange-500/30" : "bg-green-500/20 text-green-400 hover:bg-green-500/30"} px-3 py-1 rounded text-sm font-mono transition-all duration-300"
          //         data-key-id="${keyId}"
          //         title="${isActive ? "Disable this API key" : "Enable this API key"}"
          //       >
          //         ${isActive ? "‚úé Disable" : "‚úé Enable"}
          //       </button>
          //       `
          //           : ""
          //       }
          //       <button
          //         class="delete-key-btn bg-red-500/20 text-red-400 hover:bg-red-500/30 px-3 py-1 rounded text-sm font-mono transition-all duration-300"
          //         data-key-id="${keyId}"
          //         title="Permanently delete this API key"
          //       >
          //         üóëÔ∏è Delete
          //       </button>
          //     </div>
          //   </div>
          // `;
          //       })
          //       .join("");

          //     document.querySelectorAll(".toggle-key-btn").forEach((btn) => {
          //       btn.addEventListener("click", async (e) => {
          //         const button = e.currentTarget as HTMLElement;
          //         const keyId = button.getAttribute("data-key-id");
          //         const badge = document.querySelector(
          //           `[data-key-id="${keyId}"].key-status-badge`,
          //         ) as HTMLElement;
          //         const isCurrentlyActive =
          //           badge && badge.textContent?.includes("ACTIVE");

          //         console.debug("Toggle button clicked", {
          //           keyId,
          //           isCurrentlyActive,
          //           hasKeyId: !!keyId,
          //         });

          //         if (!keyId) {
          //           console.error("Toggle: Key ID is missing or undefined", {
          //             button,
          //           });
          //           alert(
          //             "‚ùå Error: API key ID not found. Please refresh and try again.",
          //           );
          //           return;
          //         }

          //         if (
          //           confirm(
          //             `‚ö†Ô∏è ${isCurrentlyActive ? "Disable" : "Enable"} API Key?\n\nAre you sure you want to ${isCurrentlyActive ? "disable" : "enable"} this API key?\n\nProceed?`,
          //           )
          //         ) {
          //           await toggleApiKey(keyId, !isCurrentlyActive);
          //         }
          //       });
          //     });

          //     document.querySelectorAll(".delete-key-btn").forEach((btn) => {
          //       btn.addEventListener("click", async (e) => {
          //         const button = e.currentTarget as HTMLElement;
          //         const keyId = button.getAttribute("data-key-id");

          //         console.debug("Delete button clicked", {
          //           keyId,
          //           hasKeyId: !!keyId,
          //         });

          //         if (!keyId) {
          //           console.error("Delete: Key ID is missing or undefined", {
          //             button,
          //           });
          //           alert(
          //             "‚ùå Error: API key ID not found. Please refresh and try again.",
          //           );
          //           return;
          //         }

          //         if (
          //           confirm(
          //             "‚ö†Ô∏è Delete API Key?\n\nAre you sure you want to permanently delete this API key?\n\n‚ö†Ô∏è This action cannot be undone\n‚ö†Ô∏è All services using this key will stop working immediately\n\nProceed with deletion?",
          //           )
          //         ) {
          //           await deleteApiKey(keyId);
          //         }
          //       });
          //     });
          //   } catch (error) {
          //     console.error("Error loading API keys", error);
          //     const container = document.getElementById("api-keys-container");
          //     if (container) {
          //       const errorMsg =
          //         error instanceof Error ? error.message : "Unknown error";
          //       container.innerHTML = `
          //     <div class="text-center py-8">
          //       <div class="text-red-400 mb-2">‚ùå Failed to load API keys</div>
          //       <p class="text-matrix-300 text-sm">${errorMsg}</p>
          //       <button 
          //         onclick="location.reload()" 
          //         class="mt-4 px-4 py-2 bg-cyber-500 hover:bg-cyber-400 text-black font-mono text-sm rounded transition-colors"
          //       >
          //         Retry
          //       </button>
          //     </div>
          //   `;
          //     }
          //   }
          // }

          // async function deleteApiKey(keyId: string) {
          //   try {
          //     // Validate keyId to prevent sending undefined to API
          //     if (!keyId || keyId === "undefined" || keyId.trim() === "") {
          //       console.error("deleteApiKey called with invalid keyId", {
          //         keyId,
          //         type: typeof keyId,
          //         length: keyId?.length,
          //       });
          //       alert(
          //         "‚ùå Error: Invalid API key ID. Please refresh the page and try again.",
          //       );
          //       return;
          //     }

          //     console.debug("Attempting to revoke API key", { keyId });

          //     // Get current keys from DOM before making the request
          //     const currentKeyElements =
          //       document.querySelectorAll("[data-key-id]");
          //     const currentKeys: string[] = [];
          //     currentKeyElements.forEach((el) => {
          //       const id = el.getAttribute("data-key-id");
          //       if (id) currentKeys.push(id);
          //     });

          //     console.debug("Current key IDs in DOM BEFORE revoke", {
          //       currentKeys,
          //       targetKeyId: keyId,
          //       exists: currentKeys.includes(keyId),
          //     });

          //     const response = await authService.revokeApiKey(keyId);

          //     console.debug("Revoke response status", {
          //       status: response.status,
          //     });

          //     if (!response.success) {
          //       let errorMsg = response.error || "Failed to revoke API key";

          //       // Handle rate limiting
          //       if (response.status === 429) {
          //         window.alert(
          //           errorMsg ||
          //             "Rate limited. Please try again in a few seconds.",
          //         );
          //         return;
          //       }

          //       if (response.status === 404) {
          //         console.warn("Got 404 - Key not found on server");

          //         // Try to get error details from response
          //         let errorDetails: any = null;
          //         try {
          //           errorDetails = response.data;
          //           console.debug("404 Error details", errorDetails);
          //           errorMsg =
          //             errorDetails?.message ||
          //             errorDetails?.detail ||
          //             "API key not found";
          //         } catch (e) {
          //           console.warn("Could not parse 404 response", e);
          //         }

          //         // Reload list to verify current state
          //         const keysCountBefore = currentKeys.length;
          //         await loadApiKeys(true); // Force refresh to bypass any caching

          //         // Get keys after reload
          //         const updatedKeyElements =
          //           document.querySelectorAll("[data-key-id]");
          //         const updatedKeys: string[] = [];
          //         updatedKeyElements.forEach((el) => {
          //           const id = el.getAttribute("data-key-id");
          //           if (id) updatedKeys.push(id);
          //         });
          //         const keysCountAfter = updatedKeys.length;

          //         console.debug("Keys count after reload", {
          //           before: keysCountBefore,
          //           after: keysCountAfter,
          //           updatedKeys,
          //         });

          //         // Check if the key we tried to delete is still in the list
          //         const keyStillExists = updatedKeys.includes(keyId);

          //         if (keyStillExists) {
          //           // KEY MISMATCH: Key exists in UI but backend says not found
          //           // Trust the backend - remove from UI since backend doesn't have it
          //           console.error(
          //             "DATA MISMATCH: Key exists in list but backend says not found. Removing from UI to sync with backend.",
          //             { keyId },
          //           );

          //           // Immediately remove the key from the DOM to sync with backend
          //           const keyElements = document.querySelectorAll(
          //             `[data-key-id="${keyId}"]`,
          //           );
          //           keyElements.forEach((el) => {
          //             const container = el.closest("div");
          //             if (container) {
          //               container.style.opacity = "0.5";
          //               container.style.pointerEvents = "none";
          //               setTimeout(() => {
          //                 container.remove();
          //               }, 300);
          //             }
          //           });

          //           alert(
          //             `‚ö†Ô∏è API Key Removed\n\n` +
          //               `The API key was not found on the server (may have been already revoked).\n` +
          //               `The key has been removed from your list.\n\n` +
          //               `If you continue to see issues, please refresh the page.`,
          //           );
          //         } else {
          //           // Key was removed from list during reload
          //           console.debug("Key no longer in list after reload");
          //           if (keysCountAfter < keysCountBefore) {
          //             alert(
          //               "‚úÖ API Key Removed\n\nThe key has been removed from your account.",
          //             );
          //           } else {
          //             alert(
          //               `‚ÑπÔ∏è API Key Not Found\n\nThe key was not found on the server (may have been already revoked).\n\n${errorDetails?.message || ""}`,
          //             );
          //           }
          //         }
          //         return; // Exit gracefully
          //       } else if (response.status === 403) {
          //         errorMsg =
          //           "You do not have permission to revoke this API key";
          //       } else if (response.status === 401) {
          //         errorMsg = "Authentication required. Please log in again";
          //       } else {
          //         // Error details are already in response.error or response.data
          //         if (response.data) {
          //           const errorData = response.data as any;
          //           errorMsg =
          //             errorData?.message || errorData?.detail || errorMsg;
          //           console.debug("Error details", errorData);
          //         }
          //       }

          //       throw new Error(errorMsg + ` (HTTP ${response.status})`);
          //     }

          //     console.info("API key revoked successfully", { keyId });

          //     // Immediately remove the key from the DOM to provide instant feedback
          //     const keyElements = document.querySelectorAll(
          //       `[data-key-id="${keyId}"]`,
          //     );
          //     console.debug("Found key elements to remove", {
          //       count: keyElements.length,
          //       keyId,
          //     });

          //     keyElements.forEach((el) => {
          //       const container = el.closest("div");
          //       if (container) {
          //         // Add fade-out animation
          //         container.style.opacity = "0.5";
          //         container.style.pointerEvents = "none";
          //         setTimeout(() => {
          //           container.remove();
          //         }, 300);
          //       }
          //     });

          //     alert(
          //       "‚úÖ API key revoked successfully\n\nThe key has been permanently deleted and can no longer be used.",
          //     );

          //     // Reload the keys list after a short delay to ensure backend is updated
          //     setTimeout(async () => {
          //       console.debug("Starting forced reload of API keys", { keyId });
          //       await loadApiKeys(true); // Force refresh to bypass any caching

          //       // Double-check the key is gone after reload
          //       const remainingElements = document.querySelectorAll(
          //         `[data-key-id="${keyId}"]`,
          //       );
          //       if (remainingElements.length > 0) {
          //         console.warn(
          //           "Key still exists after reload! Forcing removal.",
          //           {
          //             keyId,
          //             count: remainingElements.length,
          //           },
          //         );

          //         remainingElements.forEach((el) => {
          //           const container = el.closest("div");
          //           if (container) {
          //             container.style.display = "none";
          //           }
          //         });
          //       }
          //     }, 500);
          //   } catch (error) {
          //     console.error("Error revoking API key", error);
          //     const errorMsg =
          //       error instanceof Error ? error.message : "Unknown error";
          //     alert("‚ùå Failed to revoke API key\n\n" + errorMsg);
          //   }
          // }

          // async function toggleApiKey(keyId: string, shouldActivate: boolean) {
          //   try {
          //     // Validate keyId to prevent sending undefined to API
          //     if (!keyId || keyId === "undefined" || keyId.trim() === "") {
          //       console.error("toggleApiKey called with invalid keyId", {
          //         keyId,
          //         type: typeof keyId,
          //         length: keyId?.length,
          //       });
          //       alert(
          //         "‚ùå Error: Invalid API key ID. Please refresh the page and try again.",
          //       );
          //       return;
          //     }

          //     console.debug("Toggling API key", { keyId, shouldActivate });

          //     // Try the activate/deactivate endpoint first
          //     let response = (await apiClient.post(
          //       `${API_ENDPOINTS.AUTH.REVOKE_API_KEY.replace(":key_id", keyId)}/${shouldActivate ? "activate" : "deactivate"}`,
          //       {},
          //     )) as any;

          //     if (!response.ok && response.status === 404) {
          //       console.warn(
          //         "Toggle endpoint not implemented, trying PATCH method",
          //       );
          //       // Try PATCH method as fallback
          //       response = (await apiClient.patch(
          //         API_ENDPOINTS.AUTH.REVOKE_API_KEY.replace(":key_id", keyId),
          //         { is_active: shouldActivate },
          //       )) as any;
          //     }

          //     if (!response.ok) {
          //       const errorMsg =
          //         response.error ||
          //         `Failed to ${shouldActivate ? "enable" : "disable"} API key`;
          //       console.debug("Toggle error", response.data);
          //       throw new Error(`${errorMsg} (HTTP ${response.status || 500})`);
          //     }

          //     console.info("API key toggled successfully", { shouldActivate });
          //     alert(
          //       `‚úÖ API key ${shouldActivate ? "enabled" : "disabled"} successfully`,
          //     );

          //     // Reload the keys list to reflect the status change
          //     setTimeout(async () => {
          //       await loadApiKeys(true); // Force refresh to bypass any caching
          //     }, 300);
          //   } catch (error) {
          //     console.error("Error toggling API key", error);
          //     const errorMsg =
          //       error instanceof Error ? error.message : "Unknown error";
          //     alert(
          //       `‚ùå Failed to ${shouldActivate ? "enable" : "disable"} API key\n\n${errorMsg}`,
          //     );
          //   }
          // }

          // await loadApiKeys();

        //   const createBtn = document.getElementById("create-api-key-btn");
        //   const createBtnText = document.getElementById("create-api-key-text");
        //   const createBtnLoading = document.getElementById(
        //     "create-api-key-loading",
        //   );
        //   const modal = document.getElementById("create-key-modal");
        //   const closeModalBtn = document.getElementById("close-modal-btn");
        //   const cancelModalBtn = document.getElementById("cancel-modal-btn");
        //   const createKeyForm = document.getElementById("create-key-form");
        //   const keyDisplayModal = document.getElementById("key-display-modal");
        //   const closeKeyDisplayBtn = document.getElementById(
        //     "close-key-display-btn",
        //   );
        //   const copyKeyBtn = document.getElementById("copy-key-btn");

        //   const MODAL_VISIBLE_CLASSES = [
        //     "flex",
        //     "items-center",
        //     "justify-center",
        //   ];

        //   function showModal(element: HTMLElement | null) {
        //     if (!element) return;
        //     element.classList.remove("hidden");
        //     element.classList.add(...MODAL_VISIBLE_CLASSES);
        //   }

        //   function hideModal(element: HTMLElement | null) {
        //     if (!element) return;
        //     element.classList.add("hidden");
        //     element.classList.remove(...MODAL_VISIBLE_CLASSES);
        //   }

        //   createBtn?.addEventListener("click", () => {
        //     showModal(modal as HTMLElement | null);
        //   });

        //   closeModalBtn?.addEventListener("click", () => {
        //     hideModal(modal as HTMLElement | null);
        //   });

        //   cancelModalBtn?.addEventListener("click", () => {
        //     hideModal(modal as HTMLElement | null);
        //   });

        //   createKeyForm?.addEventListener("submit", async (e) => {
        //     e.preventDefault();

        //     const nameInput = document.getElementById(
        //       "key-name",
        //     ) as HTMLInputElement;
        //     const descInput = document.getElementById(
        //       "key-description",
        //     ) as HTMLTextAreaElement;

        //     // Show loading state
        //     if (createBtn) (createBtn as HTMLButtonElement).disabled = true;
        //     createBtnText?.classList.add("hidden");
        //     createBtnLoading?.classList.remove("hidden");

        //     try {
        //       const response = await authService.createApiKey({
        //         name: nameInput.value,
        //         expires_at: descInput.value || undefined,
        //       });

        //       if (!response.success) {
        //         let errorMsg = response.error || "Failed to create API key";
        //         if (response.status === 404) {
        //           errorMsg = "API Keys endpoint not implemented on backend";
        //         } else if (response.status === 429) {
        //           errorMsg =
        //             response.error || "Rate limited. Please try again later.";
        //         }
        //         throw new Error(errorMsg + ` (HTTP ${response.status || 500})`);
        //       }

        //       const data = response.data as any;

        //       console.debug("Create API Key Response", {
        //         data,
        //         apiKey: data?.api_key || data?.key,
        //       });

        //       hideModal(modal as HTMLElement | null);

        //       const generatedKeyInput = document.getElementById(
        //         "generated-key",
        //       ) as HTMLInputElement;
        //       if (generatedKeyInput && data) {
        //         generatedKeyInput.value =
        //           data.api_key ||
        //           data.key ||
        //           data.token ||
        //           "Error: Key not found in response";
        //       }
        //       showModal(keyDisplayModal as HTMLElement | null);

        //       nameInput.value = "";
        //       descInput.value = "";

        //       console.debug("Reloading API keys list");
        //       await loadApiKeys(true); // Force refresh to get newly created key
        //       console.debug("API keys list reloaded");
        //     } catch (error) {
        //       console.error("Error creating API key", error);
        //       const errorMsg =
        //         error instanceof Error ? error.message : "Unknown error";

        //       if (
        //         errorMsg.includes("not implemented") ||
        //         errorMsg.includes("404")
        //       ) {
        //         alert(
        //           "‚ö†Ô∏è API Keys Feature Not Available\n\n" +
        //             "The API Keys endpoint is not implemented on the backend server.\n\n" +
        //             "This feature requires:\n" +
        //             "‚Ä¢ Backend API endpoint: POST /api/v1/auth/api-keys\n" +
        //             "‚Ä¢ Proper authentication and authorization\n\n" +
        //             "Please contact your system administrator or check backend implementation.",
        //         );
        //       } else {
        //         alert(
        //           "‚ùå Failed to create API key\n\n" +
        //             errorMsg +
        //             "\n\nPlease try again or contact support.",
        //         );
        //       }
        //     } finally {
        //       // Hide loading state
        //       if (createBtn) (createBtn as HTMLButtonElement).disabled = false;
        //       createBtnText?.classList.remove("hidden");
        //       createBtnLoading?.classList.add("hidden");
        //     }
        //   });

        //   closeKeyDisplayBtn?.addEventListener("click", () => {
        //     hideModal(keyDisplayModal as HTMLElement | null);
        //   });

        //   copyKeyBtn?.addEventListener("click", () => {
        //     const generatedKeyInput = document.getElementById(
        //       "generated-key",
        //     ) as HTMLInputElement;
        //     generatedKeyInput.select();
        //     document.execCommand("copy");

        //     copyKeyBtn.textContent = "Copied!";
        //     setTimeout(() => {
        //       copyKeyBtn.textContent = "Copy";
        //     }, 2000);
        //   });
        // });
      </script>
    </div>

    <style>
      .terminal-border {
        border: 1px solid rgba(0, 255, 159, 0.3);
        box-shadow: 0 0 20px rgba(0, 255, 159, 0.1);
      }

      .matrix-rain {
        background: linear-gradient(
          180deg,
          transparent,
          rgba(0, 255, 159, 0.05)
        );
      }

      .settings-tab {
        position: relative;
        border-left: 4px solid transparent;
      }

      .settings-tab.active {
        color: #00ff9f;
        background-color: rgba(0, 255, 159, 0.1);
        border-left-color: #00ff9f;
      }

      .settings-tab:not(.active) {
        color: #4ade80;
      }

      .tab-content {
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </section></Layout
>
