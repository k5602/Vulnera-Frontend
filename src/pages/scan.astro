---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import Navigation from "../components/Navigation.astro";
import Footer from "../components/Footer.astro";
import ScanReportIsland from "../components/report/ScanReportIsland";
---

<Layout
  title="Scan ‚Äî Vulnera"
  description="Upload manifests or import repositories for scanning."
>
  <script>
    import { setupAuthGuard } from "../utils/auth-guard";
    setupAuthGuard({ requireAuth: true });
  </script>

  <Navigation />

  <section
    id="main"
    class="relative min-h-screen overflow-hidden bg-black"
    aria-labelledby="scan-title"
    transition:animate="fade"
  >
    <!-- Background Layers -->
    <div class="absolute inset-0 z-0">
      <div class="absolute inset-0 matrix-rain opacity-20"></div>
      <div
        class="absolute inset-0 bg-gradient-to-r from-black via-black/80 to-black/60"
      >
      </div>
      <div
        class="absolute inset-0 bg-gradient-to-b from-transparent via-matrix-900/20 to-black/80"
      >
      </div>
    </div>

    <!-- Content -->
    <div
      class="relative z-10 max-w-4xl mx-auto px-3 sm:px-4 md:px-6 py-8 sm:py-12 md:py-16"
    >
      <header class="mb-6 sm:mb-8 md:mb-10">
        <div class="text-cyber-400 font-mono text-xs sm:text-sm md:text-base">
          root@vulnera:~$
        </div>
        <h1
          id="scan-title"
          class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-bold text-white font-mono tracking-wider mt-4 sm:mt-5 md:mt-6 mb-3 sm:mb-4 md:mb-6"
        >
          <span class="text-cyber-400">&gt;</span> SCAN
        </h1>
        <p class="text-matrix-300 mt-2 text-xs sm:text-sm md:text-base">
          Upload dependency manifests or import a repository to analyze
          vulnerabilities.
        </p>
      </header>

      <!-- Upload area -->
      <section
        class="terminal-border bg-black/70 rounded-lg md:rounded-xl p-3 sm:p-4 md:p-6 overflow-hidden"
      >
        <h2
          class="text-cyber-400 font-mono text-sm sm:text-base md:text-lg mb-3 flex items-center gap-2"
        >
          <span>üìÅ</span> UPLOAD_FILES
        </h2>

        <!-- Dropzone -->
        <div
          id="dropzone"
          class="relative border-2 border-dashed border-cyber-400/40 rounded-lg p-6 sm:p-8 text-center bg-black/40 hover:bg-black/50 hover:border-cyber-400/60 transition-all group"
        >
          <div
            class="absolute inset-0 bg-gradient-to-br from-cyber-400/5 to-matrix-400/5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"
          >
          </div>
          <div class="relative z-10">
            <div class="text-4xl mb-3">üì¶</div>
            <p class="text-matrix-300 text-sm sm:text-base font-medium mb-2">
              Drag & drop your files here
            </p>
            <p class="text-gray-500 text-xs sm:text-sm mb-4">
              or click to browse
            </p>
            <div
              class="flex flex-wrap gap-1 justify-center text-xs text-gray-600 mb-4"
            >
              <span
                class="px-2 py-1 bg-black/40 rounded border border-gray-700/30"
                >package.json</span
              >
              <span
                class="px-2 py-1 bg-black/40 rounded border border-gray-700/30"
                >requirements.txt</span
              >
              <span
                class="px-2 py-1 bg-black/40 rounded border border-gray-700/30"
                >pom.xml</span
              >
              <span
                class="px-2 py-1 bg-black/40 rounded border border-gray-700/30"
                >Cargo.lock</span
              >
            </div>
            <input id="file-input" type="file" class="sr-only" multiple />
            <label
              for="file-input"
              id="btn-select"
              role="button"
              tabindex="0"
              class="inline-flex items-center cursor-pointer bg-gradient-to-r from-cyber-600 to-matrix-600 hover:from-cyber-500 hover:to-matrix-500 text-black font-bold px-4 sm:px-6 py-2.5 rounded-lg font-mono text-xs sm:text-sm terminal-border shadow-lg hover:shadow-cyber-400/20 transition-all"
            >
              <span class="mr-2">üìÇ</span> SELECT_FILES
            </label>
          </div>
        </div>

        <!-- File List -->
        <div class="mt-4 min-h-[40px]">
          <ul
            id="file-list"
            class="text-matrix-300 text-xs sm:text-sm font-mono space-y-2 max-h-40 overflow-y-auto"
          >
          </ul>
        </div>

        <!-- Action Buttons -->
        <div class="mt-5 space-y-3">
          <!-- Analysis Modules Selection -->
          <!-- Analysis Modules - Always Active -->
          <div class="border border-cyber-400/30 rounded-lg p-3 bg-black/30">
            <label class="block text-xs text-matrix-300 font-mono mb-2"
              >ALL_ANALYSIS_MODULES "Enabled by default, can not be edited"</label
            >
            <div class="grid grid-cols-2 gap-2">
              <div
                class="flex items-center gap-2 p-2 border border-cyber-400/60 rounded bg-cyber-400/10"
              >
                <div class="flex items-center gap-1.5 text-xs text-cyber-300">
                  <span>üì¶</span>
                  <span>Dependencies</span>
                </div>
              </div>
              <div
                class="flex items-center gap-2 p-2 border border-cyber-400/60 rounded bg-cyber-400/10"
              >
                <div class="flex items-center gap-1.5 text-xs text-cyber-300">
                  <span>üîç</span>
                  <span>SAST</span>
                </div>
              </div>
              <div
                class="flex items-center gap-2 p-2 border border-cyber-400/60 rounded bg-cyber-400/10"
              >
                <div class="flex items-center gap-1.5 text-xs text-cyber-300">
                  <span>üîê</span>
                  <span>Secrets</span>
                </div>
              </div>
              <div
                class="flex items-center gap-2 p-2 border border-cyber-400/60 rounded bg-cyber-400/10"
              >
                <div class="flex items-center gap-1.5 text-xs text-cyber-300">
                  <span>üåê</span>
                  <span>API Security</span>
                </div>
              </div>
            </div>
            <p class="mt-2 text-[10px] text-gray-500">
              All analysis modules are enabled by default
            </p>
          </div>

          <!-- Detail Level Selection -->
          <div class="border border-cyber-400/30 rounded-lg p-3 bg-black/30">
            <label class="block text-xs text-matrix-300 font-mono mb-2"
              >REPORT_DETAIL_LEVEL</label
            >
            <div class="flex flex-wrap gap-2">
              <button
                data-detail-level="minimal"
                class="detail-level-btn flex-1 sm:flex-none inline-flex items-center justify-center gap-1.5 border border-gray-600/40 text-gray-400 px-3 py-1.5 rounded-lg font-mono text-xs hover:bg-gray-600/10 hover:border-gray-500/60 transition-all"
              >
                <span>‚ö°</span> MINIMAL
              </button>
              <button
                data-detail-level="standard"
                class="detail-level-btn active flex-1 sm:flex-none inline-flex items-center justify-center gap-1.5 border border-cyber-400/60 bg-cyber-400/10 text-cyber-300 px-3 py-1.5 rounded-lg font-mono text-xs hover:bg-cyber-400/20 transition-all"
              >
                <span>üìä</span> STANDARD
              </button>
              <button
                data-detail-level="full"
                class="detail-level-btn flex-1 sm:flex-none inline-flex items-center justify-center gap-1.5 border border-gray-600/40 text-gray-400 px-3 py-1.5 rounded-lg font-mono text-xs hover:bg-gray-600/10 hover:border-gray-500/60 transition-all"
              >
                <span>üî¨</span> FULL
              </button>
            </div>
            <p class="mt-2 text-[10px] text-gray-500 leading-relaxed">
              <span class="text-cyan-400 font-bold">‚ö° Minimal:</span> Critical/High
              vulns only<br />
              <span class="text-cyan-400 font-bold">üìä Standard:</span> All vulns
              + CVE/CVSS + recommendations + files analysis<br />
              <span class="text-cyan-400 font-bold">üî¨ Full:</span> Complete details
              + affected files + extended recommendations
            </p>
          </div>

          <!-- Secondary Actions -->
          <div class="flex flex-wrap gap-2">
            <button
              id="btn-reset-files"
              class="flex-1 sm:flex-none inline-flex items-center justify-center gap-1.5 border border-red-400/40 text-red-300 px-3 py-2 rounded-lg font-mono text-xs hover:bg-red-400/10 hover:border-red-400/60 transition-all"
            >
              <span>üóëÔ∏è</span> RESET
            </button>
          </div>

          <!-- Primary Action -->
          <button
            id="btn-scan"
            class="w-full inline-flex items-center justify-center gap-2 bg-gradient-to-r from-cyber-500 to-matrix-500 hover:from-cyber-400 hover:to-matrix-400 text-black font-bold px-6 py-3 rounded-lg font-mono text-sm sm:text-base shadow-lg hover:shadow-cyber-400/30 transition-all transform hover:scale-[1.02]"
          >
            <span class="text-lg">üöÄ</span> START_SCAN
          </button>
        </div>
      </section>

      <!-- GitHub import -->
      <section
        id="github-import-section"
        class="mt-6 sm:mt-8 md:mt-10 terminal-border bg-black/70 rounded-lg md:rounded-xl p-3 sm:p-4 md:p-6 overflow-hidden"
      >
        <h2
          class="text-cyber-400 font-mono text-sm sm:text-base md:text-lg mb-3"
        >
          IMPORT_GITHUB_REPO
        </h2>

        <!-- GitHub Token Required Notice -->
        <div
          id="github-token-notice"
          class="hidden mb-3 p-2 sm:p-3 bg-purple-900/20 border border-purple-500/40 rounded-lg"
        >
          <div class="flex flex-col gap-2">
            <div class="flex items-center gap-2">
              <span class="text-lg">üîê</span>
              <h3
                class="text-xs sm:text-sm text-purple-400 font-bold font-mono"
              >
                GitHub Token Required
              </h3>
            </div>
            <p class="text-xs text-gray-300">
              Add token in Settings to import repos.
            </p>
            <a
              href="/settings#api-keys"
              class="inline-flex items-center justify-center gap-1 bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded font-mono text-xs transition-all w-full sm:w-auto"
            >
              <span>‚öôÔ∏è</span>
              <span>Add Token</span>
            </a>
          </div>
        </div>

        <div id="github-import-controls" class="flex flex-col gap-2">
          <input
            id="repo-url"
            type="url"
            placeholder="github.com/owner/repo"
            class="w-full px-3 py-2 rounded-lg bg-black/60 border border-cyber-400/30 focus:border-cyber-400 focus:ring-1 focus:ring-cyber-400 text-white placeholder-gray-500 text-xs sm:text-sm"
          />

          <!-- Analysis Depth Selection -->
          <div
            class="border border-cyber-400/30 rounded-lg p-2 bg-black/30 mt-2"
          >
            <label class="block text-[10px] text-matrix-300 font-mono mb-1.5"
              >DETAIL_LEVEL</label
            >
            <div class="flex gap-2">
              <button
                data-analysis-depth="minimal"
                class="analysis-depth-btn flex-1 inline-flex items-center justify-center gap-1 border border-gray-600/40 text-gray-400 px-2 py-1 rounded font-mono text-[10px] hover:bg-gray-600/10 transition-all"
              >
                MINIMAL
              </button>
              <button
                data-analysis-depth="standard"
                class="analysis-depth-btn active flex-1 inline-flex items-center justify-center gap-1 border border-cyber-400/60 bg-cyber-400/10 text-cyber-300 px-2 py-1 rounded font-mono text-[10px] transition-all"
              >
                STANDARD
              </button>
              <button
                data-analysis-depth="full"
                class="analysis-depth-btn flex-1 inline-flex items-center justify-center gap-1 border border-gray-600/40 text-gray-400 px-2 py-1 rounded font-mono text-[10px] hover:bg-gray-600/10 transition-all"
              >
                FULL
              </button>
            </div>
          </div>

          <button
            id="btn-import"
            class="w-full inline-flex items-center justify-center bg-gradient-to-r from-cyber-600 to-matrix-600 hover:from-cyber-500 hover:to-matrix-500 text-black px-3 py-2 rounded-lg font-mono text-xs sm:text-sm terminal-border cursor-pointer transition-colors"
          >
            <span class="mr-1">&gt;</span> IMPORT_REPO
          </button>
        </div>
        <p class="text-gray-400 text-xs mt-2">
          Fetch manifest files and analyze dependencies.
        </p>
      </section>

      <!-- Report Island Mount -->
      <div class="mt-4">
        <ScanReportIsland client:idle />
      </div>
    </div>
  </section>

  <Footer />

  <script >
    import { apiClient } from "../utils/api/client";
    import { API_ENDPOINTS } from "../config/api";
    import { getCookie } from "../utils/cookies";
    import { logger } from "../utils/logger";
    import { detectEcosystem } from "../utils/scan-handler";

    // GitHub Token Management
    function checkGithubToken() {
      const token = getCookie("github_token");
      const notice = document.getElementById("github-token-notice");
      const controls = document.getElementById("github-import-controls");
      const btnImport = document.getElementById("btn-import");
      const repoUrl = document.getElementById("repo-url");

      if (!token) {
        // No token - show notice and disable controls
        notice?.classList.remove("hidden");
        if (btnImport) {
          btnImport.disabled = true;
          btnImport.classList.add("opacity-50", "cursor-not-allowed");
          btnImport.classList.remove("cursor-pointer");
        }
        if (repoUrl) {
          repoUrl.disabled = true;
          repoUrl.classList.add("opacity-50", "cursor-not-allowed");
        }
      } else {
        // Token exists - hide notice and enable controls
        notice?.classList.add("hidden");
        if (btnImport) {
          btnImport.disabled = false;
          btnImport.classList.remove("opacity-50", "cursor-not-allowed");
          btnImport.classList.add("cursor-pointer");
        }
        if (repoUrl) {
          repoUrl.disabled = false;
          repoUrl.classList.remove("opacity-50", "cursor-not-allowed");
        }
      }

      return token;
    }

    // Check token on page load
    checkGithubToken();

    // Listen for token updates from settings page
    window.addEventListener("github-token-updated", () => {
      checkGithubToken();
    });

    // Handle navigation to settings with hash
    window.addEventListener("load", () => {
      if (window.location.hash === "#api-keys") {
        const apiKeysTab = document.querySelector('[data-tab="api-keys"]');
        if (apiKeysTab && apiKeysTab.click) {
          apiKeysTab.click();
        }
      }
    });

    function initializeHandlers() {
      // Disable browser default file-open on drop anywhere
      document.addEventListener("dragover", (e) => e.preventDefault());
      document.addEventListener("drop", (e) => e.preventDefault());

      // Get elements
      const dz = document.getElementById("dropzone");
      const input = document.getElementById("file-input");
      const list = document.getElementById("file-list");
      const btnSelect = document.getElementById("btn-select");
      const btnScan = document.getElementById("btn-scan");
      const btnImport = document.getElementById("btn-import");
      const btnReset = document.getElementById("btn-reset-files");
      const repoUrl = document.getElementById("repo-url");
      const detailLevelBtns = document.querySelectorAll(".detail-level-btn");
      const analysisDepthBtns = document.querySelectorAll(
        ".analysis-depth-btn"
      );
      let pickedFiles = [];
      let selectedDetailLevel = "standard"; // Default
      let selectedAnalysisDepth = "standard"; // Default

      // All modules are always enabled
      const ALL_MODULES = ["dependencies", "sast", "secrets", "api"];

      // Function to get all analysis modules (always returns all 4)
      function getSelectedModules() {
        return ALL_MODULES;
      }

      // Handle detail level selection
      detailLevelBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          // Remove active class from all buttons
          detailLevelBtns.forEach((b) => {
            b.classList.remove(
              "active",
              "border-cyber-400/60",
              "bg-cyber-400/10",
              "text-cyber-300"
            );
            b.classList.add("border-gray-600/40", "text-gray-400");
          });

          // Add active class to clicked button
          btn.classList.add(
            "active",
            "border-cyber-400/60",
            "bg-cyber-400/10",
            "text-cyber-300"
          );
          btn.classList.remove("border-gray-600/40", "text-gray-400");

          // Update selected detail level
          selectedDetailLevel = btn.getAttribute("data-detail-level");
          logger.debug("Detail level selected:", selectedDetailLevel);
        });
      });

      // Handle analysis depth selection
      analysisDepthBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          // Remove active class from all buttons
          analysisDepthBtns.forEach((b) => {
            b.classList.remove(
              "active",
              "border-cyber-400/60",
              "bg-cyber-400/10",
              "text-cyber-300"
            );
            b.classList.add("border-gray-600/40", "text-gray-400");
          });

          // Add active class to clicked button
          btn.classList.add(
            "active",
            "border-cyber-400/60",
            "bg-cyber-400/10",
            "text-cyber-300"
          );
          btn.classList.remove("border-gray-600/40", "text-gray-400");

          // Update selected analysis depth
          const depthValue = btn.getAttribute("data-analysis-depth");
          selectedAnalysisDepth = depthValue || "standard";
          logger.debug("Analysis depth selected:", selectedAnalysisDepth);
        });
      });

      function renderFiles() {
        if (!list) return;
        list.innerHTML = "";
        if (pickedFiles.length === 0) {
          list.innerHTML =
            '<li class="text-gray-500 text-center py-2">No files selected</li>';
          return;
        }
        pickedFiles.forEach((f, index) => {
          const li = document.createElement("li");
          li.className =
            "flex items-center justify-between gap-2 bg-black/40 border border-matrix-500/30 rounded px-3 py-2 hover:bg-black/60 transition-colors";

          const fileInfo = document.createElement("div");
          fileInfo.className = "flex items-center gap-2 flex-1 min-w-0";

          const icon = document.createElement("span");
          icon.textContent = "üìÑ";
          icon.className = "text-sm";

          const text = document.createElement("span");
          text.className = "truncate text-xs sm:text-sm";
          text.textContent = `${f.name}`;

          const size = document.createElement("span");
          size.className = "text-xs text-gray-500 whitespace-nowrap";
          size.textContent = `(${Math.round(f.size / 1024)} KB)`;

          fileInfo.appendChild(icon);
          fileInfo.appendChild(text);
          fileInfo.appendChild(size);

          const removeBtn = document.createElement("button");
          removeBtn.className =
            "text-red-400 hover:text-red-300 text-xs px-2 py-1 hover:bg-red-400/10 rounded transition-colors";
          removeBtn.textContent = "‚úï";
          removeBtn.title = "Remove file";
          removeBtn.onclick = () => {
            pickedFiles.splice(index, 1);
            renderFiles();
          };

          li.appendChild(fileInfo);
          li.appendChild(removeBtn);
          list.appendChild(li);
        });
      }

      function handleFiles(files) {
        const incoming = files ? Array.from(files) : [];
        if (!incoming.length) return;
        pickedFiles = [...pickedFiles, ...incoming].slice(0, 50);
        renderFiles();
      }

      // Drag and drop handlers
      dz?.addEventListener("dragenter", (e) => {
        e.preventDefault();
        dz.classList.add("bg-black/50");
      });

      dz?.addEventListener("dragover", (e) => {
        e.preventDefault();
        if (e.dataTransfer) e.dataTransfer.dropEffect = "copy";
        dz.classList.add("bg-black/50");
      });

      dz?.addEventListener("dragleave", () => {
        dz.classList.remove("bg-black/50");
      });

      dz?.addEventListener("drop", (e) => {
        e.preventDefault();
        dz.classList.remove("bg-black/50");
        handleFiles(e.dataTransfer?.files ?? null);
      });

      input?.addEventListener("change", () => handleFiles(input?.files));

      // RESET_FILES handler
      btnReset?.addEventListener("click", () => {
        pickedFiles = [];
        renderFiles();
        repoUrl.value = "";
      });

      function dispatchReport(report) {
        window.dispatchEvent(
          new CustomEvent("vulnera:scan-report", { detail: report })
        );
      }

      // START_SCAN handler - Using new /api/v1/dependencies/analyze endpoint
      btnScan?.addEventListener("click", async () => {
        if (!pickedFiles.length) {
          alert("Select files to scan.");
          return;
        }

        try {
          btnScan.disabled = true;
          btnScan.textContent = "> SCANNING...";

          // Check authentication
          const token = getCookie("auth_token");
          const apiKey = getCookie("api_key");
          if (!token && !apiKey) {
            alert(
              "‚ö†Ô∏è Authentication required\n\nPlease log in first or generate an API key in Settings."
            );
            return;
          }

          // Get all analysis modules (always all 4 modules)
          const selectedModules = getSelectedModules();

          // Prepare batch request for all files
          const filesPayload = [];

          for (const file of pickedFiles) {
            try {
              const content = await file.text();

              // Detect ecosystem from filename
              const ecosystem = detectEcosystem(file.name);

              filesPayload.push({
                filename: file.name,
                ecosystem: ecosystem,
                file_content: content,
              });
            } catch (e) {
              logger.error(`Error reading file ${file.name}`, e);
            }
          }

          if (!filesPayload.length) {
            alert("No valid files to analyze");
            return;
          }

          // Build query parameters
          const queryParams = new URLSearchParams({
            detail_level: selectedDetailLevel,
          });

          // Add selected modules
          selectedModules.forEach((module) => {
            queryParams.append("modules", module);
          });

          // Call new batch dependencies analyze endpoint using apiClient
          const endpoint = `${API_ENDPOINTS.ANALYSIS.ANALYZE_DEPENDENCIES}?${queryParams.toString()}`;
          const apiResponse = await apiClient.post(endpoint, {
            files: filesPayload,
          });

          if (!apiResponse.success) {
            if (apiResponse.status === 401) {
              alert(
                "‚ö†Ô∏è Authentication Error\n\nYour session has expired. Please log in again."
              );
              return;
            }
            if (apiResponse.status === 404) {
              alert(
                "‚ö†Ô∏è Endpoint Not Found\n\nThe backend API endpoint does not exist. Please check backend implementation."
              );
              return;
            }
            if (apiResponse.status === 429) {
              alert(
                "‚ö†Ô∏è Rate Limit Exceeded\n\nToo many requests. Please try again later."
              );
              return;
            }
            throw new Error(apiResponse.error || `HTTP ${apiResponse.status}`);
          }

          const result = apiResponse.data;

          // Transform new API response to report format
          const fileAnalyses = [];
          const allVulnerabilities = [];
          const allFindings = {
            dependencies: [],
            sast: [],
            secrets: [],
            api: [],
          };

          if (result.results && Array.isArray(result.results)) {
            result.results.forEach((fileResult) => {
              if (fileResult.error) {
                logger.error(
                  `Error analyzing ${fileResult.filename}`,
                  fileResult.error
                );
                return;
              }

              // Add file analysis
              fileAnalyses.push({
                file: fileResult.filename,
                ecosystem: fileResult.ecosystem || "unknown",
                dependencies: fileResult.metadata?.total_packages || 0,
                vulnerable: fileResult.metadata?.vulnerable_packages || 0,
              });

              // Process dependency vulnerabilities
              if (
                fileResult.vulnerabilities &&
                Array.isArray(fileResult.vulnerabilities)
              ) {
                fileResult.vulnerabilities.forEach((vuln) => {
                  const vulnerability = {
                    id: vuln.id,
                    type: "dependency",
                    severity: vuln.severity?.toUpperCase() || "UNKNOWN",
                    package: vuln.affected_packages?.[0]?.name || "unknown",
                    version: vuln.affected_packages?.[0]?.version || "",
                    title: vuln.summary || vuln.description || "No description",
                    cve: vuln.id,
                    affectedFiles: [fileResult.filename],
                    cvss: vuln.cvss_score,
                    recommendation: vuln.affected_packages?.[0]
                      ?.fixed_versions?.[0]
                      ? `Upgrade to ${vuln.affected_packages[0].fixed_versions[0]}`
                      : undefined,
                  };
                  allVulnerabilities.push(vulnerability);
                  allFindings.dependencies.push(vulnerability);
                });
              }

              // Process SAST findings
              if (
                fileResult.sast_findings &&
                Array.isArray(fileResult.sast_findings)
              ) {
                fileResult.sast_findings.forEach((finding) => {
                  const sastFinding = {
                    id: finding.id || `sast-${Date.now()}-${Math.random()}`,
                    type: "sast",
                    severity: finding.severity?.toUpperCase() || "MEDIUM",
                    title:
                      finding.title ||
                      finding.description ||
                      "Code quality issue",
                    description: finding.description,
                    location: finding.location,
                    line: finding.line_number,
                    cwe: finding.cwe,
                    affectedFiles: [fileResult.filename],
                    recommendation: finding.recommendation,
                  };
                  allVulnerabilities.push(sastFinding);
                  allFindings.sast.push(sastFinding);
                });
              }

              // Process Secrets findings
              if (fileResult.secrets && Array.isArray(fileResult.secrets)) {
                fileResult.secrets.forEach((secret) => {
                  const secretFinding = {
                    id: secret.id || `secret-${Date.now()}-${Math.random()}`,
                    type: "secret",
                    severity: "HIGH",
                    title: `${secret.type || "Secret"} detected`,
                    description:
                      secret.description ||
                      "Sensitive information found in code",
                    location: secret.location,
                    line: secret.line_number,
                    secretType: secret.type,
                    affectedFiles: [fileResult.filename],
                    recommendation:
                      "Remove sensitive data and rotate credentials",
                  };
                  allVulnerabilities.push(secretFinding);
                  allFindings.secrets.push(secretFinding);
                });
              }

              // Process API Security findings
              if (
                fileResult.api_findings &&
                Array.isArray(fileResult.api_findings)
              ) {
                fileResult.api_findings.forEach((finding) => {
                  const apiFinding = {
                    id: finding.id || `api-${Date.now()}-${Math.random()}`,
                    type: "api",
                    severity: finding.severity?.toUpperCase() || "MEDIUM",
                    title: finding.title || "API security issue",
                    description: finding.description,
                    endpoint: finding.endpoint,
                    method: finding.method,
                    affectedFiles: [fileResult.filename],
                    recommendation: finding.recommendation,
                  };
                  allVulnerabilities.push(apiFinding);
                  allFindings.api.push(apiFinding);
                });
              }
            });
          }

          // Build consolidated report with detail level
          const report = {
            startedAt: new Date().toISOString(),
            finishedAt: new Date().toISOString(),
            durationMs: result.metadata?.duration_ms || 0,
            detailLevel: selectedDetailLevel, // Add detail level to report
            summary: {
              files: fileAnalyses.length,
              dependencies: fileAnalyses.reduce(
                (sum, f) => sum + (f.dependencies || 0),
                0
              ),
              vulnerabilities: allVulnerabilities.length,
              critical: allVulnerabilities.filter(
                (v) => v.severity === "CRITICAL"
              ).length,
              high: allVulnerabilities.filter((v) => v.severity === "HIGH")
                .length,
              medium: allVulnerabilities.filter((v) => v.severity === "MEDIUM")
                .length,
              low: allVulnerabilities.filter((v) => v.severity === "LOW")
                .length,
              byType: {
                dependencies: allFindings.dependencies.length,
                sast: allFindings.sast.length,
                secrets: allFindings.secrets.length,
                api: allFindings.api.length,
              },
            },
            files: fileAnalyses,
            vulnerabilities: allVulnerabilities,
            findings: allFindings,
            modules: getSelectedModules(),
          };

          logger.info("Scan completed successfully", {
            reportId: report.startedAt,
          });

          // Save scan result to localStorage for dashboard
          try {
            const scanHistory = JSON.parse(
              localStorage.getItem("scan_history") || "[]"
            );
            const scanRecord = {
              id: `scan_${Date.now()}`,
              timestamp: new Date().toISOString(),
              filesCount: pickedFiles.length,
              vulnerabilities: allVulnerabilities.length,
              critical: report.summary.critical,
              high: report.summary.high,
              medium: report.summary.medium,
              low: report.summary.low,
              files: fileAnalyses.map((f) => f.file),
              ecosystems: [...new Set(fileAnalyses.map((f) => f.ecosystem))],
              report: report,
            };
            scanHistory.unshift(scanRecord); // Add to beginning
            // Keep only last 50 scans
            if (scanHistory.length > 50) scanHistory.length = 50;
            localStorage.setItem("scan_history", JSON.stringify(scanHistory));
          } catch (e) {
            logger.error("Failed to save scan to history", e);
          }

          dispatchReport(report);
        } catch (e) {
          logger.error("Scan error", e);
          alert("Failed to start scan: " + (e?.message || "Unknown error"));
        } finally {
          btnScan.disabled = false;
          btnScan.textContent = "> START_SCAN";
        }
      });

      // IMPORT_REPO handler - Using new /api/v1/analyze/job endpoint
      btnImport?.addEventListener("click", async () => {
        const url = repoUrl?.value?.trim?.() ?? "";
        if (!url || !/^https?:\/\/github.com\//i.test(url)) {
          alert("Please enter a valid GitHub repository URL.");
          return;
        }

        // Get GitHub token from input field or cookie
        const githubTokenInput = document.getElementById("github-token-input");
        const githubToken =
          githubTokenInput?.value?.trim() || getCookie("github_token");

        try {
          btnImport.disabled = true;
          btnImport.textContent = "> IMPORTING...";

          // Check authentication (apiClient handles auth automatically)
          const token = getCookie("auth_token");
          const apiKey = getCookie("api_key");
          if (!token && !apiKey) {
            alert(
              "‚ö†Ô∏è Authentication required\n\nPlease log in first or generate an API key in Settings."
            );
            return;
          }

          // Note: GitHub token (X-GitHub-Token header) would need to be added to apiClient if needed
          // For now, apiClient handles standard auth (API key or Bearer token)
          // Extract owner and repo from GitHub URL
          const urlObj = new URL(url);
          const pathParts = urlObj.pathname.split("/").filter((p) => p);
          const owner = pathParts[0];
          const repo = pathParts[1]?.replace(/\.git$/, "");

          if (!owner || !repo) {
            throw new Error(
              "Invalid GitHub URL. Expected format: https://github.com/owner/repo"
            );
          }

          // Ensure analysis_depth is a valid value
          const validDepths = ["minimal", "standard", "full"];
          const analysisDepth = validDepths.includes(selectedAnalysisDepth)
            ? selectedAnalysisDepth
            : "standard";

          // Build request body according to OpenAPI spec
          const requestBody = {
            source_type: "git",
            source_uri: `https://github.com/${owner}/${repo}.git`,
            analysis_depth: analysisDepth,
          };

          // Call analyze/job endpoint
          const apiResponse = await apiClient.post(
            API_ENDPOINTS.ANALYSIS.ANALYZE,
            requestBody
          );

          if (!apiResponse.success) {
            if (apiResponse.status === 401) {
              throw new Error(
                "Authentication failed: Your session has expired or the token is invalid. Please log in again."
              );
            }
            if (apiResponse.status === 404) {
              throw new Error(
                "Endpoint not found: The backend API endpoint /api/v1/analyze/job does not exist. Please check backend implementation."
              );
            }
            if (apiResponse.status === 429) {
              throw new Error("Rate limit exceeded. Please try again later.");
            }
            throw new Error(
              apiResponse.error || `HTTP ${apiResponse.status}: Request failed`
            );
          }

          const result = apiResponse.data;

          // Check job status
          if (result.status === "failed") {
            throw new Error(
              "Repository analysis failed. Please check the repository URL and try again."
            );
          }

          // Transform job response to report format
          const fileAnalyses = [];
          const allVulnerabilities = [];
          const allFindings = {
            dependencies: [],
            sast: [],
            secrets: [],
            api: [],
          };

          // Process findings by type
          if (result.findings && Array.isArray(result.findings)) {
            result.findings.forEach((finding) => {
              const findingType = finding.type || "unknown";
              const affectedFiles = finding.location?.path
                ? [finding.location.path]
                : [];

              if (findingType === "dependency") {
                const depFinding = {
                  id: finding.id || `dep-${Date.now()}-${Math.random()}`,
                  type: "dependency",
                  severity: finding.severity?.toUpperCase() || "UNKNOWN",
                  package: finding.package_name || "unknown",
                  version: finding.package_version || "",
                  title:
                    finding.title ||
                    finding.description ||
                    "Dependency vulnerability",
                  cve: finding.cve_id || finding.id,
                  affectedFiles: affectedFiles,
                  cvss: finding.cvss_score,
                  recommendation: finding.recommendation,
                };
                allVulnerabilities.push(depFinding);
                allFindings.dependencies.push(depFinding);
              } else if (findingType === "sast") {
                const sastFinding = {
                  id: finding.id || `sast-${Date.now()}-${Math.random()}`,
                  type: "sast",
                  severity: finding.severity?.toUpperCase() || "MEDIUM",
                  title:
                    finding.title ||
                    finding.description ||
                    "Code quality issue",
                  description: finding.description,
                  location: finding.location,
                  line: finding.location?.line_number,
                  cwe: finding.cwe_id,
                  affectedFiles: affectedFiles,
                  recommendation: finding.recommendation,
                };
                allVulnerabilities.push(sastFinding);
                allFindings.sast.push(sastFinding);
              } else if (findingType === "secret") {
                const secretFinding = {
                  id: finding.id || `secret-${Date.now()}-${Math.random()}`,
                  type: "secret",
                  severity: "HIGH",
                  title: `${finding.secret_type || "Secret"} detected`,
                  description:
                    finding.description || "Sensitive information found",
                  location: finding.location,
                  line: finding.location?.line_number,
                  secretType: finding.secret_type,
                  affectedFiles: affectedFiles,
                  recommendation:
                    "Remove sensitive data and rotate credentials",
                };
                allVulnerabilities.push(secretFinding);
                allFindings.secrets.push(secretFinding);
              } else if (findingType === "api") {
                const apiFinding = {
                  id: finding.id || `api-${Date.now()}-${Math.random()}`,
                  type: "api",
                  severity: finding.severity?.toUpperCase() || "MEDIUM",
                  title: finding.title || "API security issue",
                  description: finding.description,
                  endpoint: finding.endpoint,
                  method: finding.http_method,
                  affectedFiles: affectedFiles,
                  recommendation: finding.recommendation,
                };
                allVulnerabilities.push(apiFinding);
                allFindings.api.push(apiFinding);
              }
            });
          }

          // Build report with analysis depth
          const report = {
            startedAt: new Date().toISOString(),
            finishedAt: new Date().toISOString(),
            durationMs: 0,
            project: `${owner}/${repo}`,
            detailLevel: selectedAnalysisDepth, // Add analysis depth as detail level
            summary: {
              files: result.summary?.modules_completed || 0,
              dependencies: 0,
              vulnerabilities:
                result.summary?.total_findings || allVulnerabilities.length,
              critical: result.summary?.critical || 0,
              high: result.summary?.high || 0,
              medium: result.summary?.medium || 0,
              low: result.summary?.low || 0,
              byType: {
                dependencies: allFindings.dependencies.length,
                sast: allFindings.sast.length,
                secrets: allFindings.secrets.length,
                api: allFindings.api.length,
              },
            },
            files: fileAnalyses,
            vulnerabilities: allVulnerabilities,
            findings: allFindings,
            modules: getSelectedModules(),
          };

          // Save scan result to localStorage for dashboard
          try {
            const scanHistory = JSON.parse(
              localStorage.getItem("scan_history") || "[]"
            );
            const scanRecord = {
              id: `scan_${Date.now()}`,
              timestamp: new Date().toISOString(),
              type: "repository",
              project: `${owner}/${repo}`,
              filesCount: report.files?.length || 0,
              vulnerabilities: report.summary.vulnerabilities,
              critical: report.summary.critical,
              high: report.summary.high,
              medium: report.summary.medium,
              low: report.summary.low,
              ecosystems: [
                ...new Set(report.files?.map((f) => f.ecosystem) || []),
              ],
              report: report,
            };
            scanHistory.unshift(scanRecord);
            if (scanHistory.length > 50) scanHistory.length = 50;
            localStorage.setItem("scan_history", JSON.stringify(scanHistory));
          } catch (e) {
            logger.error("Failed to save scan to history", e);
          }

          // Dispatch report to display
          dispatchReport(report);

          // Clear the file list after successful import
          pickedFiles = [];
          renderFiles();

          alert(
            `Repository analyzed successfully!\n\nTotal vulnerabilities: ${report.summary.vulnerabilities || 0}`
          );
        } catch (e) {
          logger.error("Repository import error", e);
          let errorMsg = "Unknown error";

          // Handle fetch abort/timeout
          if (e instanceof Error && e.name === "AbortError") {
            errorMsg =
              "Request timeout: The repository analysis took too long. The backend may be busy or the repository may be very large. Please try again later.";
          } else if (e instanceof Error) {
            errorMsg = e.message;
          } else if (typeof e === "string") {
            errorMsg = e;
          } else {
            errorMsg = JSON.stringify(e);
          }

          // Add fallback message if error is empty
          if (!errorMsg || errorMsg.trim() === "") {
            errorMsg =
              "Backend endpoint may not be implemented or server is unreachable";
          }

          // Enhanced error messages based on error type
          let alertTitle = "‚ùå Failed to import repository";
          let suggestions =
            "Please check:\n‚Ä¢ Repository URL is correct\n‚Ä¢ Repository is public or you have access\n‚Ä¢ Backend server is running and accessible";

          if (
            errorMsg.includes("Authentication failed") ||
            errorMsg.includes("expired") ||
            errorMsg.includes("401")
          ) {
            alertTitle = "‚ö†Ô∏è Authentication Error";
            suggestions = "Please log in again to continue.";
          } else if (
            errorMsg.includes("404") ||
            errorMsg.includes("not found") ||
            errorMsg.includes("Endpoint not found")
          ) {
            alertTitle = "‚ö†Ô∏è Backend API Not Available";
            suggestions =
              "The backend endpoint does not exist.\n\nThis feature requires:\n‚Ä¢ Backend API v1 with /api/v1/analyze/job endpoint\n‚Ä¢ Proper backend deployment and configuration";
          } else if (errorMsg.includes("JSON") || errorMsg.includes("parse")) {
            alertTitle = "‚ö†Ô∏è Invalid Backend Response";
            suggestions =
              "The backend returned an unexpected response format.\n\nPossible causes:\n‚Ä¢ Backend is not running\n‚Ä¢ Backend returned HTML error page\n‚Ä¢ API endpoint returns wrong content type";
          } else if (
            errorMsg.includes("NetworkError") ||
            errorMsg.includes("Failed to fetch")
          ) {
            alertTitle = "‚ö†Ô∏è Network Error";
            suggestions =
              "Cannot connect to backend server.\n\nPlease check:\n‚Ä¢ Backend server is running\n‚Ä¢ CORS is properly configured\n‚Ä¢ Check API configuration";
          }

          alert(`${alertTitle}\n\n${errorMsg}\n\n${suggestions}`);
        } finally {
          btnImport.disabled = false;
          btnImport.textContent = "> IMPORT_REPO";
        }
      });
    }

    // Initialize when DOM is ready
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initializeHandlers);
    } else {
      initializeHandlers();
    }
  </script>
</Layout>
