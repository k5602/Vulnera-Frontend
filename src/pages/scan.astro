---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import Navigation from "../components/Navigation.astro";
import Footer from "../components/Footer.astro";
import ScanReportIsland from "../components/report/ScanReportIsland";
---

<Layout
  title="Scan ‚Äî Vulnera"
  description="Upload manifests or import repositories for scanning."
>
  <!-- Server-side middleware handles auth -->

  <Navigation />

  <section
    id="main"
    class="relative min-h-screen overflow-hidden bg-black"
    aria-labelledby="scan-title"
    transition:animate="fade"
  >
    <!-- Background Layers -->
    <div class="absolute inset-0 z-0">
      <div class="absolute inset-0 matrix-rain opacity-20"></div>
      <div
        class="absolute inset-0 bg-gradient-to-r from-black via-black/80 to-black/60"
      >
      </div>
      <div
        class="absolute inset-0 bg-gradient-to-b from-transparent via-matrix-900/20 to-black/80"
      >
      </div>
    </div>

    <!-- Content -->
    <div
      class="relative z-10 max-w-4xl mx-auto px-3 sm:px-4 md:px-6 py-8 sm:py-12 md:py-16"
    >
      <header class="mb-6 sm:mb-8 md:mb-10">
        <div class="text-cyber-400 font-mono text-xs sm:text-sm md:text-base">
          root@vulnera:~$
        </div>
        <h1
          id="scan-title"
          class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-bold text-white font-mono tracking-wider mt-4 sm:mt-5 md:mt-6 mb-3 sm:mb-4 md:mb-6"
        >
          <span class="text-cyber-400">&gt;</span> SCAN
        </h1>
        <p class="text-matrix-300 mt-2 text-xs sm:text-sm md:text-base">
          Upload dependency manifests or import a repository to analyze
          vulnerabilities.
        </p>
      </header>

      <!-- Upload area -->
      <section
        class="terminal-border bg-black/70 rounded-lg md:rounded-xl p-3 sm:p-4 md:p-6 overflow-hidden"
      >
        <h2
          class="text-cyber-400 font-mono text-sm sm:text-base md:text-lg mb-3 flex items-center gap-2"
        >
          <span>üìÅ</span> UPLOAD_FILES
        </h2>

        <!-- Dropzone -->
        <div
          id="dropzone"
          class="relative border-2 border-dashed border-cyber-400/40 rounded-lg p-6 sm:p-8 text-center bg-black/40 hover:bg-black/50 hover:border-cyber-400/60 transition-all group"
        >
          <div
            class="absolute inset-0 bg-gradient-to-br from-cyber-400/5 to-matrix-400/5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"
          >
          </div>
          <div class="relative z-10">
            <div class="text-4xl mb-3">üì¶</div>
            <p class="text-matrix-300 text-sm sm:text-base font-medium mb-2">
              Drag & drop your files here
            </p>
            <p class="text-gray-500 text-xs sm:text-sm mb-4">
              or click to browse
            </p>
            <div
              class="flex flex-wrap gap-1 justify-center text-xs text-gray-600 mb-4"
            >
              <span
                class="px-2 py-1 bg-black/40 rounded border border-gray-700/30"
                >package.json</span
              >
              <span
                class="px-2 py-1 bg-black/40 rounded border border-gray-700/30"
                >requirements.txt</span
              >
              <span
                class="px-2 py-1 bg-black/40 rounded border border-gray-700/30"
                >pom.xml</span
              >
              <span
                class="px-2 py-1 bg-black/40 rounded border border-gray-700/30"
                >Cargo.lock</span
              >
            </div>
            <input id="file-input" type="file" class="sr-only" multiple />
            <label
              for="file-input"
              id="btn-select"
              role="button"
              tabindex="0"
              class="inline-flex items-center cursor-pointer bg-gradient-to-r from-cyber-600 to-matrix-600 hover:from-cyber-500 hover:to-matrix-500 text-black font-bold px-4 sm:px-6 py-2.5 rounded-lg font-mono text-xs sm:text-sm terminal-border shadow-lg hover:shadow-cyber-400/20 transition-all"
            >
              <span class="mr-2">üìÇ</span> SELECT_FILES
            </label>
          </div>
        </div>

        <!-- File List -->
        <div class="mt-4 min-h-[40px]">
          <ul
            id="file-list"
            class="text-matrix-300 text-xs sm:text-sm font-mono space-y-2 max-h-40 overflow-y-auto"
          >
          </ul>
        </div>

        <div class="mt-5 space-y-3">
        
          <!-- Detail Level Selection -->
          <div class="border border-cyber-400/30 rounded-lg p-3 bg-black/30">
            <label class="block text-xs text-matrix-300 font-mono mb-2"
              >REPORT_DETAIL_LEVEL</label
            >
            <div class="flex flex-wrap gap-2">
              <button
                data-detail-level="minimal"
                class="detail-level-btn flex-1 sm:flex-none inline-flex items-center justify-center gap-1.5 border border-gray-600/40 text-gray-400 px-3 py-1.5 rounded-lg font-mono text-xs hover:bg-gray-600/10 hover:border-gray-500/60 transition-all"
              >
                <span>‚ö°</span> MINIMAL
              </button>
              <button
                data-detail-level="standard"
                class="detail-level-btn active flex-1 sm:flex-none inline-flex items-center justify-center gap-1.5 border border-cyber-400/60 bg-cyber-400/10 text-cyber-300 px-3 py-1.5 rounded-lg font-mono text-xs hover:bg-cyber-400/20 transition-all"
              >
                <span>üìä</span> STANDARD
              </button>
              <button
                data-detail-level="full"
                class="detail-level-btn flex-1 sm:flex-none inline-flex items-center justify-center gap-1.5 border border-gray-600/40 text-gray-400 px-3 py-1.5 rounded-lg font-mono text-xs hover:bg-gray-600/10 hover:border-gray-500/60 transition-all"
              >
                <span>üî¨</span> FULL
              </button>
            </div>
            <p class="mt-2 text-[10px] text-gray-500 leading-relaxed">
              <span class="text-cyan-400 font-bold">‚ö° Minimal:</span> Critical/High
              vulns only<br />
              <span class="text-cyan-400 font-bold">üìä Standard:</span> All vulns
              + CVE/CVSS + recommendations + files analysis<br />
              <span class="text-cyan-400 font-bold">üî¨ Full:</span> Complete details
              + affected files + extended recommendations
            </p>
          </div>

          <!-- Secondary Actions -->
          <div class="flex flex-wrap gap-2">
            <button
              id="btn-reset-files"
              class="flex-1 sm:flex-none inline-flex items-center justify-center gap-1.5 border border-red-400/40 text-red-300 px-3 py-2 rounded-lg font-mono text-xs hover:bg-red-400/10 hover:border-red-400/60 transition-all"
            >
              <span>üóëÔ∏è</span> RESET
            </button>
          </div>

          <!-- Primary Action -->
          <button
            id="btn-scan"
            class="w-full inline-flex items-center justify-center gap-2 bg-gradient-to-r from-cyber-500 to-matrix-500 hover:from-cyber-400 hover:to-matrix-400 text-black font-bold px-6 py-3 rounded-lg font-mono text-sm sm:text-base shadow-lg hover:shadow-cyber-400/30 transition-all transform hover:scale-[1.02]"
          >
            <span class="text-lg">üöÄ</span> START_SCAN
          </button>
        </div>
      </section>

      <!-- GitHub import -->
      <section
        id="github-import-section"
        class="mt-6 sm:mt-8 md:mt-10 terminal-border bg-black/70 rounded-lg md:rounded-xl p-3 sm:p-4 md:p-6 overflow-hidden"
      >
        <h2
          class="text-cyber-400 font-mono text-sm sm:text-base md:text-lg mb-3"
        >
          IMPORT_GITHUB_REPO
        </h2>

        <!-- GitHub Token Required Notice -->
        <div
          id="github-token-notice"
          class="hidden mb-3 p-2 sm:p-3 bg-purple-900/20 border border-purple-500/40 rounded-lg"
        >
          <div class="flex flex-col gap-2">
            <div class="flex items-center gap-2">
              <span class="text-lg">üîê</span>
              <h3
                class="text-xs sm:text-sm text-purple-400 font-bold font-mono"
              >
                GitHub Token Required For Private Repo
              </h3>
            </div>
            <p class="text-xs text-gray-300">
              Add token in Settings to import private repos. If repo is public
              ignore this notice.
            </p>
            <a
              href="/settings#api-keys"
              class="inline-flex items-center justify-center gap-1 bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded font-mono text-xs transition-all w-full sm:w-auto"
            >
              <span>‚öôÔ∏è</span>
              <span>Add Token</span>
            </a>
          </div>
        </div>

        <div id="github-import-controls" class="flex flex-col gap-2">
          <input
            id="repo-url"
            type="url"
            placeholder="github.com/owner/repo"
            class="w-full px-3 py-2 rounded-lg bg-black/60 border border-cyber-400/30 focus:border-cyber-400 focus:ring-1 focus:ring-cyber-400 text-white placeholder-gray-500 text-xs sm:text-sm"
          />

          <!-- Analysis Depth Selection -->
          <div
            class="border border-cyber-400/30 rounded-lg p-2 bg-black/30 mt-2"
          >
            <label class="block text-[10px] text-matrix-300 font-mono mb-1.5"
              >DETAIL_LEVEL</label
            >
            <div class="flex gap-2">
              <button
                data-analysis-depth="minimal"
                class="analysis-depth-btn flex-1 inline-flex items-center justify-center gap-1 border border-gray-600/40 text-gray-400 px-2 py-1 rounded font-mono text-[10px] hover:bg-gray-600/10 transition-all"
              >
                MINIMAL
              </button>
              <button
                data-analysis-depth="standard"
                class="analysis-depth-btn active flex-1 inline-flex items-center justify-center gap-1 border border-cyber-400/60 bg-cyber-400/10 text-cyber-300 px-2 py-1 rounded font-mono text-[10px] transition-all"
              >
                STANDARD
              </button>
              <button
                data-analysis-depth="full"
                class="analysis-depth-btn flex-1 inline-flex items-center justify-center gap-1 border border-gray-600/40 text-gray-400 px-2 py-1 rounded font-mono text-[10px] hover:bg-gray-600/10 transition-all"
              >
                FULL
              </button>
            </div>
          </div>

          <button
            id="btn-import"
            class="w-full inline-flex items-center justify-center bg-gradient-to-r from-cyber-600 to-matrix-600 hover:from-cyber-500 hover:to-matrix-500 text-black px-3 py-2 rounded-lg font-mono text-xs sm:text-sm terminal-border cursor-pointer transition-colors"
          >
            <span class="mr-1">&gt;</span> IMPORT_REPO
          </button>
        </div>
        <p class="text-gray-400 text-xs mt-2">
          Fetch manifest files and analyze dependencies.
        </p>
      </section>

      <!-- Report Island Mount -->
      <div class="mt-4">
        <ScanReportIsland client:idle />
      </div>
    </div>
  </section>

  <Footer />

  <script>
    import { ScanHandler } from "../modules/scanModule";

    const scanHandler = new ScanHandler(
      document.getElementById("dropzone")!,
      document.getElementById("file-input")! as HTMLInputElement,
      document.getElementById("file-list")!,
      document.getElementById("btn-scan")! as HTMLButtonElement,
      document.getElementById("btn-import")! as HTMLButtonElement,
      document.getElementById("btn-reset-files")! as HTMLButtonElement,
      document.getElementById("repo-url")! as HTMLInputElement,
      document.querySelectorAll(".detail-level-btn"),
      document.querySelectorAll(".analysis-depth-btn"),
    );

    // GitHub Token Management
    // Check token on page load
    scanHandler.checkGithubToken();

    // Listen for token updates from settings page
    window.addEventListener("github-token-updated", () => {
      scanHandler.checkGithubToken();
    });

    // Handle navigation to settings with hash
    // window.addEventListener("load", () => {
    //   if (window.location.hash === "#api-keys") {
    //     const apiKeysTab = document.querySelector('[data-tab="api-keys"]');
    //     if (apiKeysTab && apiKeysTab.click) {
    //       apiKeysTab.click();
    //     }
    //   }
    // });

    function initializeHandlers() {
      // Disable browser default file-open on drop anywhere
      document.addEventListener("dragover", (e) => e.preventDefault());
      document.addEventListener("drop", (e) => e.preventDefault());

      // Handle detail level selection
      scanHandler.addActiveBTNDetailClass();

      // Handle analysis depth selection
      scanHandler.addActiveBTNAnalysisClass();

      scanHandler.renderFiles();

      // Drag and drop handlers
      scanHandler.dragAndDropSetup();
      scanHandler.input?.addEventListener("change", () =>
        scanHandler.handleFiles(scanHandler.input?.files),
      );

      // RESET_FILES handler
      scanHandler.btnReset?.addEventListener("click", () => {
        scanHandler.pickedFiles = [];
        scanHandler.renderFiles();
        scanHandler.repoUrl.value = "";
      });

      // START_SCAN handler - Using new /api/v1/dependencies/analyze endpoint
      scanHandler.btnScan?.addEventListener("click", () =>
        scanHandler.startScan(),
      );
      // IMPORT_REPO handler - Using new /api/v1/analyze/job endpoint
      scanHandler.btnImport?.addEventListener("click", () =>
        scanHandler.importRepository(),
      );
    }

    // Initialize when DOM is ready
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initializeHandlers);
    } else {
      initializeHandlers();
    }
  </script>
</Layout>