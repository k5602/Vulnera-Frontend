/**
 * Vulnerability Service
 * Handles vulnerability data operations
 */

import { API_ENDPOINTS } from '../../config/api';
import { apiClient, type ApiResponse } from './client';

export interface VulnerabilityDetail {
  id: string;
  cveId: string;
  ghsaId?: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  description: string;
  affectedVersions: string[];
  fixedVersion?: string;
  cvssScore?: number;
  cvssVector?: string;
  references: Array<{
    type: 'advisory' | 'issue' | 'fix' | 'other';
    url: string;
  }>;
  publishedDate: string;
  modifiedDate: string;
}

export interface VulnerabilityListResponse {
  vulnerabilities: VulnerabilityDetail[];
  total: number;
  page: number;
  pageSize: number;
}

export interface SearchRequest {
  query: string;
  ecosystem?: string;
  severity?: string;
  page?: number;
  pageSize?: number;
}

export interface CacheRefreshResponse {
  success: boolean;
  message: string;
  cacheSize?: number;
  packagesCount?: number;
  timestamp: string;
}

class VulnerabilityService {
  /**
   * Get vulnerability details by ID
   * GET /api/v1/vulnerabilities/{id}
   */
  async getVulnerability(vulnerabilityId: string): Promise<ApiResponse<VulnerabilityDetail>> {
    const endpoint = apiClient.replacePath(API_ENDPOINTS.VULNERABILITIES.GET, {
      id: vulnerabilityId,
    });
    return apiClient.get<VulnerabilityDetail>(endpoint);
  }

  /**
   * List vulnerabilities with pagination
   * GET /api/v1/vulnerabilities
   */
  async listVulnerabilities(
    page: number = 1,
    pageSize: number = 20
  ): Promise<ApiResponse<VulnerabilityListResponse>> {
    const endpoint = `${API_ENDPOINTS.VULNERABILITIES.LIST}?page=${page}&pageSize=${pageSize}`;
    return apiClient.get<VulnerabilityListResponse>(endpoint);
  }

  /**
   * Refresh popular packages vulnerability cache
   * POST /api/v1/vulnerabilities/refresh-cache
   */
  async refreshCache(): Promise<ApiResponse<CacheRefreshResponse>> {
    return apiClient.post<CacheRefreshResponse>(
      API_ENDPOINTS.VULNERABILITIES.REFRESH_CACHE,
      {}
    );
  }

  /**
   * Search vulnerabilities
   * NOTE: Not implemented in current backend - using LIST endpoint instead
   */
  async searchVulnerabilities(request: SearchRequest): Promise<ApiResponse<VulnerabilityListResponse>> {
    // TODO: Implement search when backend adds support
    // For now, fallback to LIST endpoint
    const page = request.page || 1;
    const pageSize = request.pageSize || 20;
    return this.listVulnerabilities(page, pageSize);
  }

  /**
   * Get vulnerabilities by CVE ID
   * NOTE: Not fully implemented - uses list as fallback
   */
  async searchByCve(_cveId: string): Promise<ApiResponse<VulnerabilityDetail[]>> {
    return this.listVulnerabilities().then((response) => ({
      ...response,
      data: response.data?.vulnerabilities || [],
    }));
  }

  /**
   * Get vulnerabilities by severity
   * NOTE: Not fully implemented - uses list as fallback
   */
  async getVulnerabilitiesBySeverity(
    _severity: 'critical' | 'high' | 'medium' | 'low',
    page: number = 1,
    pageSize: number = 20
  ): Promise<ApiResponse<VulnerabilityListResponse>> {
    // TODO: Filter by severity when backend supports it
    return this.listVulnerabilities(page, pageSize);
  }
}

export const vulnerabilityService = new VulnerabilityService();
